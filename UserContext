// components/ui/UserContext.tsx
import React, { createContext, useState, useEffect, ReactNode } from "react";
import AsyncStorage from "@react-native-async-storage/async-storage";
import { graphqlRequest, setAuthToken } from "@/services/api";
import { ActivityIndicator } from "react-native";

interface UserContextType {
  token: string | null;
  user: any;
  login: (token: string, user: any) => Promise<void>;
  logout: () => Promise<void>;
  setUser: (user: any) => void;
  setToken: (token: string | null) => void;
}

interface UserProviderProps {
  children: ReactNode;
}

export const UserContext = createContext<UserContextType>({
  token: null,
  user: null,
  login: async () => {},
  logout: async () => {},
  setUser: () => {},
  setToken: () => {},
});

export const UserProvider: React.FC<UserProviderProps> = ({ children }) => {
  const [token, setToken] = useState<string | null>(null);
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadTokenAndUser = async () => {
      try {
        const savedToken = await AsyncStorage.getItem("token");
        console.log("SAVED TOKEN:", savedToken);

        if (savedToken) {
          setToken(savedToken);
          setAuthToken(savedToken);

          // Fetch logged-in user from backend
          const response = await graphqlRequest(
            `{ currentUser { id email role admin customer } }`,
            {},
            savedToken
          );

          console.log("CURRENT USER RESPONSE:", response);

          if (response?.currentUser) {
            console.log("Loaded user:", response.currentUser);
            setUser(response.currentUser);
          } else {
            console.log("Invalid token → removing");
            await AsyncStorage.removeItem("token");
            setToken(null);
            setUser(null);
          }
        } else {
          console.log("No saved token → user=null");
          setToken(null);
          setUser(null);
        }
      } catch (err) {
        console.error("Error restoring session:", err);
        await AsyncStorage.removeItem("token");
        setToken(null);
        setUser(null);
      } finally {
        setLoading(false);
      }
    };

    loadTokenAndUser();
  }, []);

  const login = async (tokenValue: string, userData: any) => {
    console.log("LOGIN SUCCESS, STORING TOKEN & USER");
    setToken(tokenValue);
    setUser(userData);
    setAuthToken(tokenValue);
    await AsyncStorage.setItem("token", tokenValue);
  };

  const logout = async () => {
    console.log("LOGGING OUT...");
    setToken(null);
    setUser(null);
    setAuthToken(undefined);
    await AsyncStorage.removeItem("token");
  };

  return (
    <UserContext.Provider value={{ token, user, login, logout, setUser, setToken }}>
      {loading ? (
        <ActivityIndicator size="large" style={{ marginTop: 40 }} />
      ) : (
        children
      )}
    </UserContext.Provider>
  );
};
