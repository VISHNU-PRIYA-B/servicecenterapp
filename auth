import { graphqlRequest, setAuthToken} from "./api";
import AsyncStorage from "@react-native-async-storage/async-storage";

export { setAuthToken };

export const fetchCurrentUser = async(token?:string) =>{
    const query = `
    query{
    currentUser{
    id
    email
    role 
    customer
    admin
    }
    }
    `;
    try{
        const data = await graphqlRequest(query,{},token);
        return data?.currentUser || null;
     }
     catch(error){
        console.error("Error fetching user",error);
        return null;
     }
};

// Signup
export const signupUser = async (email: string, password: string, role: string) => {
  const SIGNUP_MUTATION = `
    mutation CreateUser($email: String!, $password: String!, $role: String!) {
      createUser(email: $email, password: $password, role: $role) {
        user { id email role }
        token
        success
        message
      }
    }
  `;
  try {
    const data = await graphqlRequest(SIGNUP_MUTATION, { email, password, role });
    const result = data?.createUser;
    if (result?.success) return { success: true, token: result.token, user: result.user };
    return { success: false, message: result?.message || "Signup failed" };
  } catch (error) {
    console.error("Signup error:", error);
    return { success: false, message: "Something went wrong" };
  }
};

// Login
export const loginUser = async (email: string, password: string) => {
  const LOGIN_MUTATION = `
    mutation CustomTokenAuth($email: String!, $password: String!) {
      customTokenAuth(email: $email, password: $password) {
        token
        user{
        id
        email
        role
        customer
        admin
        }
      }
    }
  `;
  try {
    const data = await graphqlRequest(LOGIN_MUTATION, { email, password });
    const token = data?.customTokenAuth?.token;
    const user = data?.customTokenAuth?.user;
    if (!token || !user) {
      throw new Error ("Invalid email or password");
    }
    setAuthToken(token);
    await AsyncStorage.setItem("token", token);
    return {token, user };
  } catch (error:any) {
    console.error("Login error:", error);
    throw new Error(error.message || "Login Failed");
  }
};


